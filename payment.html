<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>스터디크랙 - 컨설팅 신청</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="logo-container">
            <a href="index.html" style="display: flex; align-items: center; gap: 10px;">
                <img src="study_cracked_logo.png" alt="로고">
                <span class="logo">StudyCrack</span>
            </a>
        </div>
    </header>

    <div class="payment-container">
        <h2 style="text-align: center; margin-bottom: 30px;">컨설팅 신청서 작성</h2>
        
        <form id="paymentForm">
            <div class="form-group">
                <label for="name">이름 (학생 본인)</label>
                <input type="text" id="name" required placeholder="예: 홍길동">
            </div>
            <div class="form-group">
                <label for="phone">전화번호</label>
                <input type="tel" id="phone" required placeholder="예: 010-1234-5678">
            </div>
            <div class="form-group">
                <label for="email">이메일</label>
                <input type="email" id="email" required placeholder="예: student@example.com">
            </div>

            <h3>신청할 프로그램 선택</h3>
            <div class="product-selection">
                <div class="product-option" onclick="selectProduct(this, 'option1', 'https://buy.stripe.com/test_7sY7sN8bp5uc1s8cPuaZi02')">
                    <div class="product-header" name='원포인트 상담'>
                        <span>원포인트 입시 전략 상담</span>
                        <span>150,000원</span>
                    </div>
                    <small>현재 위치 진단 및 전략 수립</small>
                </div>

                <div class="product-option" onclick="selectProduct(this, 'option2', 'https://buy.stripe.com/test_14A3cx77l6yg1s85n2aZi03')">
                    <div class="product-header" name='월간 학습코칭'>
                        <span>월간 학습 코칭 (플래닝)</span>
                        <span>400,000원</span>
                    </div>
                    <small>주 1회 점검 및 데일리 플래너 피드백</small>
                </div>

                <div class="product-option" onclick="selectProduct(this, 'option3', 'https://buy.stripe.com/test_aFa6oJ4ZdbSA7QweXCaZi04')">
                    <div class="product-header" name='배치 컨설팅'>
                        <span>수시/정시 배치 컨설팅</span>
                        <span>300,000원</span>
                    </div>
                    <small>지원 대학 라인업 및 최종 전략</small>
                </div>
            </div>

            <button type="button" class="btn-pay" id="submitBtn" onclick="processPayment()">결제하기</button>
        </form>
    </div>

    <script>
        let selectedProductUrl = "";
        let selectedProductName = "";

        // 전화번호 포맷팅 함수
        function formatPhoneNumber(rawPhone) {
            // 1. 숫자 이외의 문자는 모두 제거
            let cleaned = rawPhone.replace(/[^0-9]/g, '');

            // 2. 혹시 '1012345678' 처럼 맨 앞 0을 빼고 넣었을 경우를 대비해 0 추가
            if (cleaned.startsWith('10') && cleaned.length === 10) {
                cleaned = '0' + cleaned;
            }

            // 3. 정규식으로 하이픈(-) 추가
            // 11자리(010-1234-5678) 또는 10자리(010-123-4567) 모두 대응
            return cleaned.replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
        }

        // 입력할 때 자동으로 하이픈 넣어주기
        const phoneInput = document.getElementById('phone');
        phoneInput.addEventListener('input', (e) => {
            const val = e.target.value.replace(/[^0-9]/g, '');
            // 입력된 숫자를 포맷팅해서 다시 입력창에 보여줌
            if(val.length >= 4) {
                 e.target.value = val.replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`);
            }
        });

        function selectProduct(element, optionId, url) {
            // 1. 모든 옵션 선택 스타일 해제
            document.querySelectorAll('.product-option').forEach(el => el.classList.remove('selected'));
            
            // 2. 클릭한 옵션 선택 스타일 적용
            element.classList.add('selected');
            selectedProductUrl = url;
            
            // 3. name 속성값 가져오기
            const headerDiv = element.querySelector('.product-header');
            selectedProductName = headerDiv.getAttribute('name');
        }

        async function processPayment() {
            const name = document.getElementById('name').value;
            const rawPhone = document.getElementById('phone').value; // 입력된 원본 값
            const email = document.getElementById('email').value;

            // 상품 선택 여부 확인
            if(!name || !rawPhone || !email || !selectedProductUrl) {
                alert("모든 정보를 입력하고 상품을 선택해주세요.");
                return;
            }

            // [핵심 수정] 전화번호 포맷팅 적용
            // 여기서 하이픈이 들어간 깔끔한 번호로 바뀝니다.
            const formattedPhone = formatPhoneNumber(rawPhone);

            // 버튼 비활성화
            const btn = document.getElementById('submitBtn');
            btn.innerText = "처리 중...";
            btn.disabled = true;

            // 1. 고유 주문번호 생성
            const uniqueId = 'ORD-' + Date.now() + '-' + Math.floor(Math.random() * 1000);

            // 2. AWS Lambda URL
            const LAMBDA_URL = "https://5ydzn4zzijnh3zhzv2npa7tseq0nbnmi.lambda-url.ap-northeast-2.on.aws/"; 

            try {
                const response = await fetch(LAMBDA_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'submit_form',
                        uniqueId: uniqueId,
                        name: name,
                        phone: formattedPhone, // [수정됨] 포맷팅된 번호를 전송
                        email: email,
                        product: selectedProductName
                    })
                });

                if (response.ok) {
                    // 3. Stripe 이동 (성공 시)
                    window.location.href = `${selectedProductUrl}?client_reference_id=${uniqueId}&prefilled_email=${email}`;
                } else {
                    alert("오류가 발생했습니다. 다시 시도해주세요.");
                    btn.disabled = false;
                    btn.innerText = "결제하기";
                }
            } catch (error) {
                console.error("Error:", error);
                alert("서버 통신 오류");
                btn.disabled = false;
                btn.innerText = "결제하기";
            }
        }
    </script>
</body>
</html>