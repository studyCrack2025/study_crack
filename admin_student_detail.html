<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìƒ ìƒì„¸ ê´€ë¦¬ - StudyCrack Admin</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/mypage.css"> <link rel="stylesheet" href="css/admin.css">
    <style>
        /* ê´€ë¦¬ì ì „ìš© í—¤ë” ìŠ¤íƒ€ì¼ */
        .admin-header-bar { background: #1e293b; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .back-btn { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: bold; }
        
        /* ê´€ë¦¬ì ë©”ëª¨ ë°•ìŠ¤ ê°•ì¡° */
        .admin-memo-container {
            max-width: 1200px; margin: 20px auto; padding: 20px;
            background-color: #fff7ed; border: 2px solid #fdba74; border-radius: 8px;
        }
        .admin-memo-container textarea { width: 100%; height: 100px; margin-top: 10px; padding: 10px; border: 1px solid #cbd5e1; resize: vertical; }
        .save-memo-btn { margin-top: 10px; padding: 10px 20px; background: #ea580c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="admin-header-bar">
        <span>ğŸ”’ ê´€ë¦¬ì ëª¨ë“œ: í•™ìƒ ìƒì„¸ ì¡°íšŒ</span>
        <a href="admin.html" class="back-btn">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <div class="admin-memo-container">
        <h3>ğŸ“ ê´€ë¦¬ì ìƒë‹´ ë…¸íŠ¸ (í•™ìƒì—ê²Œ ë³´ì´ì§€ ì•ŠìŒ)</h3>
        <textarea id="adminMemoInput" placeholder="ì´ í•™ìƒì— ëŒ€í•œ íŠ¹ì´ì‚¬í•­, ìƒë‹´ ë‚´ìš© ë“±ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
        <button onclick="saveAdminMemo()" class="save-memo-btn">ë©”ëª¨ ì €ì¥</button>
    </div>

    <div class="mypage-container" style="margin-top: 20px;">
        <aside class="profile-summary" id="profileBox">
            <div class="profile-pic-area">
                <img src="assets/images/sample_profile.png" alt="í”„ë¡œí•„" class="profile-img">
            </div>
            <h2 id="viewName">-</h2>
            <p id="viewEmail">-</p>
            
            <div class="survey-status-box">
                <h4>ê¸°ì´ˆì¡°ì‚¬ì„œ ìƒíƒœ</h4>
                <div id="statusBadge" class="status-badge incomplete">ë¯¸ì‘ì„±</div>
            </div>
        </aside>

        <main class="content-area">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('info')">ê¸°ë³¸ ì •ë³´</button>
                <button class="tab-btn" onclick="switchTab('qual')">ì •ì„± ì¡°ì‚¬ì„œ</button>
                <button class="tab-btn" onclick="switchTab('quan')">ì„±ì í‘œ</button>
                <button class="tab-btn" onclick="switchTab('pay')">ê²°ì œ ë‚´ì—­</button>
            </div>

            <div id="tab_info" class="tab-content active">
                <h3>ê¸°ë³¸ ì¸ì ì‚¬í•­</h3>
                <p><strong>í•™êµ:</strong> <span id="viewSchool">-</span></p>
                <p><strong>ì „í™”ë²ˆí˜¸:</strong> <span id="viewPhone">-</span></p>
            </div>

            <div id="tab_qual" class="tab-content">
                <h3>ì§„ë¡œ ë° ëª©í‘œ</h3>
                <p><strong>í˜„ì¬ ìƒíƒœ:</strong> <span id="viewStatus">-</span></p>
                <p><strong>í¬ë§ ê³„ì—´:</strong> <span id="viewStream">-</span></p>
                <p><strong>í¬ë§ ì§„ë¡œ:</strong> <span id="viewCareer">-</span></p>
                <p><strong>ëª©í‘œ ëŒ€í•™:</strong> <span id="viewTargets">-</span></p>
            </div>

            <div id="tab_quan" class="tab-content">
                <h3>ì„±ì  ë°ì´í„°</h3>
                <div id="viewScoreTable">ë°ì´í„° ì—†ìŒ</div>
            </div>

            <div id="tab_pay" class="tab-content">
                <h3>ê²°ì œ ì´ë ¥</h3>
                <ul id="viewPaymentList" class="payment-history"></ul>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script>
        // ê°„ë‹¨í•œ íƒ­ ì „í™˜ ìŠ¤í¬ë¦½íŠ¸ (mypage.js ì•ˆ ì“°ê³  ë…ë¦½ì ìœ¼ë¡œ ë™ì‘)
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab_' + tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // URL íŒŒë¼ë¯¸í„°ì—ì„œ í•™ìƒ ID ê°€ì ¸ì˜¤ê¸°
        const urlParams = new URLSearchParams(window.location.search);
        const targetUserId = urlParams.get('uid');
        const adminId = localStorage.getItem('userId');
        const ADMIN_API_URL = "https://txbtj65lvfsbprfcfg6dlgruhm0iyjjg.lambda-url.ap-northeast-2.on.aws/";

        document.addEventListener('DOMContentLoaded', async () => {
            if (!targetUserId || !adminId) {
                alert("ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.");
                window.location.href = 'admin.html';
                return;
            }
            await loadStudentDetail();
        });

        async function loadStudentDetail() {
            try {
                const response = await fetch(ADMIN_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'admin_get_user_detail',
                        userId: adminId,
                        data: { targetUserId: targetUserId }
                    })
                });
                const s = await response.json();
                renderData(s);
            } catch (e) {
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
            }
        }

        function renderData(s) {
            // 1. ë©”ëª¨
            document.getElementById('adminMemoInput').value = s.adminMemo || '';
            
            // 2. í”„ë¡œí•„
            document.getElementById('viewName').innerText = s.name || 'ì´ë¦„ ì—†ìŒ';
            document.getElementById('viewEmail').innerText = s.email || '-';
            
            // ìœ ë£ŒíšŒì› ë±ƒì§€
            if (s.payments && s.payments.length > 0) {
                document.getElementById('profileBox').classList.add('paid-member');
            }

            // 3. íƒ­ ë°ì´í„° ë°”ì¸ë”©
            setText('viewSchool', s.school);
            setText('viewPhone', s.phone);
            
            const q = s.qualitative || {};
            setText('viewStatus', q.status);
            setText('viewStream', q.stream);
            setText('viewCareer', q.career);
            setText('viewTargets', q.targets ? q.targets.join(', ') : '-');

            // ì„±ì í‘œ
            const quan = s.quantitative || {};
            const scoreBox = document.getElementById('viewScoreTable');
            if(Object.keys(quan).length > 0) {
                let html = '<ul style="line-height:1.8">';
                for(const [exam, d] of Object.entries(quan)) {
                    html += `<li><strong>${exam}:</strong> êµ­(${d.kor?.grd}), ìˆ˜(${d.math?.grd}), ì˜(${d.eng?.grd})</li>`;
                }
                html += '</ul>';
                scoreBox.innerHTML = html;
            }

            // ê²°ì œë‚´ì—­
            const payList = document.getElementById('viewPaymentList');
            if(s.payments) {
                s.payments.forEach(p => {
                    payList.innerHTML += `<li class="payment-item"><span class="pay-product">${p.product}</span> <span class="pay-date">${p.date} / ${p.amount}ì›</span></li>`;
                });
            } else {
                payList.innerHTML = "<li>ë‚´ì—­ ì—†ìŒ</li>";
            }
        }

        function setText(id, txt) {
            const el = document.getElementById(id);
            if(el) el.innerText = txt || '-';
        }

        async function saveAdminMemo() {
            const memo = document.getElementById('adminMemoInput').value;
            try {
                await fetch(ADMIN_API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        type: 'admin_update_memo',
                        userId: adminId,
                        data: { targetUserId: targetUserId, memo: memo }
                    })
                });
                alert("ë©”ëª¨ ì €ì¥ ì™„ë£Œ");
            } catch(e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
        }
    </script>
</body>
</html>